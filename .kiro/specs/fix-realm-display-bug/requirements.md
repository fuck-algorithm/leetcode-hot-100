# 修复境界显示 Bug - 需求文档

## 1. 问题描述

当前系统在判断和显示用户当前境界时存在严重的逻辑错误：

### 1.1 核心问题
- `ExperienceRecord.level` 字段被错误地用来存储 realm 索引（0-10），而不是用户等级（1-100）
- `ExperienceBar` 组件正确使用 `getCurrentRealm(totalExp)` 计算境界索引
- `RealmHelpTooltip` 组件错误地使用 `experience.level` 字段来匹配境界
- `UIMigrationService` 在迁移时将 realm 索引写入 `level` 字段
- `ExperienceAdapter.addExperience()` 也将 level 计算为 1-100 的等级，但迁移后被覆盖

### 1.2 表现症状
- 用户有 11 经验值时，应该显示"练气期"（realm 0）
- 但实际显示"筑基期"或其他错误的境界
- 帮助提示框中的"当前境界"标记位置错误

### 1.3 根本原因
`ExperienceRecord.level` 字段的语义不明确，被不同模块理解为不同的含义：
- 在新系统中应该是 1-100 的等级
- 但迁移服务将其用作 realm 索引（0-10）
- 导致数据不一致

## 2. 用户故事

### 2.1 作为用户
**我想要**：看到正确的当前境界显示  
**以便**：了解我的真实修炼进度

**验收标准**：
- 当我有 0-49999 经验值时，显示"练气期"
- 当我有 50000-119999 经验值时，显示"筑基期"
- 当我有 120000-209999 经验值时，显示"金丹期"
- 以此类推，境界显示与经验值阈值完全对应

### 2.2 作为用户
**我想要**：帮助提示框中正确标记我的当前境界  
**以便**：快速找到我在境界列表中的位置

**验收标准**：
- 帮助提示框中"当前"标记出现在正确的境界上
- 标记的境界与主界面显示的境界一致

### 2.3 作为开发者
**我想要**：`ExperienceRecord.level` 字段有明确的语义  
**以便**：避免混淆和错误使用

**验收标准**：
- `level` 字段始终表示 1-100 的用户等级
- 所有模块使用 `getCurrentRealm(totalExp)` 来获取境界索引
- 不再将 realm 索引存储到 `level` 字段

## 3. 功能需求

### 3.1 修复 UIMigrationService
**需求**：迁移服务应该正确计算并存储用户等级（1-100），而不是 realm 索引

**详细说明**：
- 使用 `experienceSystem.getCurrentLevel(newExp)` 计算等级
- 将等级（1-100）存储到 `level` 字段
- 不再将 realm 索引存储到 `level` 字段

### 3.2 修复 RealmHelpTooltip
**需求**：帮助提示框应该基于经验值计算当前境界，而不是使用 `level` 字段

**详细说明**：
- 接收 `totalExp` 参数而不是 `currentLevel`
- 使用 `experienceAdapter.getCurrentRealm(totalExp)` 获取境界索引
- 直接使用境界索引来标记当前境界

### 3.3 统一境界计算逻辑
**需求**：所有组件都应该使用相同的方式计算当前境界

**详细说明**：
- 统一使用 `experienceAdapter.getCurrentRealm(totalExp)` 获取境界索引
- 境界索引范围：0-10
- 不再使用 `level` 字段来判断境界

### 3.4 清理冗余字段
**需求**：移除 `RealmInfo` 中不再使用的 `minLevel` 和 `maxLevel` 字段

**详细说明**：
- `REALMS` 数组中的 `minLevel` 和 `maxLevel` 字段已经没有实际用途
- 应该移除这些字段，避免混淆
- 使用数组索引（0-10）来表示境界

## 4. 非功能需求

### 4.1 向后兼容性
- 已迁移的用户数据应该能够正常工作
- 如果 `level` 字段包含错误的 realm 索引，应该重新计算正确的等级

### 4.2 数据一致性
- `level` 字段应该始终与 `totalExp` 对应的等级一致
- 每次更新经验值时，都应该重新计算等级

### 4.3 代码清晰度
- 变量命名应该清晰表达其含义（`realmIndex` vs `level`）
- 添加注释说明 `level` 字段的语义

## 5. 技术约束

### 5.1 不破坏现有 API
- `ExperienceRecord` 接口保持不变
- `ExperienceAdapter` 的公共方法保持不变

### 5.2 最小化修改范围
- 只修改必要的文件
- 不影响其他功能模块

## 6. 测试需求

### 6.1 单元测试
- 测试 `getCurrentRealm()` 在各个经验值阈值的边界情况
- 测试迁移服务正确计算等级

### 6.2 集成测试
- 测试 UI 显示与经验值的对应关系
- 测试帮助提示框的"当前"标记位置

### 6.3 回归测试
- 测试经验值增加后境界正确更新
- 测试宝箱开启后境界正确更新

## 7. 验收标准

### 7.1 功能正确性
- [ ] 用户有 11 经验值时，显示"练气期"
- [ ] 用户有 50000 经验值时，显示"筑基期"
- [ ] 帮助提示框中"当前"标记位置正确
- [ ] `experience.level` 字段包含正确的等级（1-100）

### 7.2 代码质量
- [ ] 所有组件使用统一的境界计算逻辑
- [ ] 移除冗余的 `minLevel` 和 `maxLevel` 字段
- [ ] 添加必要的注释说明

### 7.3 测试覆盖
- [ ] 所有边界情况都有测试覆盖
- [ ] 测试通过率 100%
